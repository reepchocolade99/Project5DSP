{% extends "layout.html" %}

{% block title %}{{ t.upload_title if t else 'Upload' }}{% endblock %}

{% block content %}
<main class="container">
    <section class="hero">
        <h1>{{ t.index_title if t else 'Image Classifier' }}</h1>
        <p>{{ t.index_subtitle if t else 'Automated evidence analysis and legal support.' }}</p>
    </section>

    <form id="uploadForm" action="/predict" method="post" enctype="multipart/form-data">
        <div class="main-grid">

            <div class="card upload-card">
                <h3>{{ t.upload_file if t else 'Upload File' }}</h3>
                <div class="custom-file-input">
                    <input type="file" name="file" id="fileInput" accept="image/*,.pdf,application/pdf" />
                    <div class="file-input-display" id="fileInputDisplay">
                        <button type="button" class="file-choose-btn" id="chooseFileBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            {{ t.choose_file if t else 'Choose File' }}
                        </button>
                        <span class="file-name" id="fileName">{{ t.no_file_chosen if t else 'No file chosen' }}</span>
                    </div>
                    <p class="drag-drop-text">{{ t.drag_drop if t else 'or drag and drop a file here' }}</p>
                </div>
                <p id="errorMessage" class="error-message">
                    {{ t.select_error if t else 'Please select an image or PDF file before submitting.' }}
                </p>
            </div>

            <div class="card settings-card">
                <div class="settings-header">
                    <h3>{{ t.settings if t else 'Settings' }}</h3>
                </div>

                <div class="setting-group">
                    <label>{{ t.language_label if t else 'Language' }}</label>
                    <select name="language" id="languageSelect">
                        <option value="en" {% if lang == 'en' %}selected{% endif %}>{{ t.language_en if t else 'English' }}</option>
                        <option value="nl" {% if lang == 'nl' %}selected{% endif %}>{{ t.language_nl if t else 'Nederlands' }}</option>
                    </select>
                </div>

                <div class="setting-group toggle-group">
                    <div>
                        <label>{{ t.decision_support if t else 'Decision Support' }}</label>
                        <small>{{ t.decision_support_desc if t else 'Enable AI-powered legal reasoning suggestions' }}</small>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="decision_support" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-group">
                    <label>{{ t.output_file_type if t else 'Output File Type' }}</label>
                    <div class="radio-options">
                        <label class="radio-item">
                            <input type="radio" name="filetype" value="pdf" checked> PDF
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="filetype" value="docx"> DOCX
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <label>{{ t.model_type if t else 'Model Type' }}</label>
                    <select name="model" id="modelSelect">
                        <option value="mllm" selected>MLLM (Claude Vision)</option>
                        <option value="openai">MLLM (OpenAI GPT-4o)</option>
                        <option value="openai_sam" disabled class="coming-soon-option">MLLM (OpenAI+SAM) - Coming Soon</option>
                        <option value="mock">Mock Data (UI Testing)</option>
                    </select>
                    <small id="modelDesc">{{ t.model_desc_mllm if t else 'Claude Vision AI for advanced image analysis' }}</small>
                </div>

                <button type="submit" class="btn btn-primary full-width" id="submitBtn">
                    {{ t.start_analysis if t else 'Start Analysis & Save Settings' }}
                </button>
            </div>
        </div>
    </form>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 class="loading-title" id="loadingTitle">{{ t.analyzing if t else 'Analyzing...' }}</h3>
            <p class="loading-subtitle" id="loadingSubtitle">{{ t.processing_images if t else 'Processing images and extracting data' }}</p>
            <div class="loading-progress">
                <div class="progress-steps">
                    <div class="step active" id="step1">
                        <div class="step-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <span>{{ t.extracting_data if t else 'Extracting data' }}</span>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <span>{{ t.analyzing_images if t else 'Analyzing images' }}</span>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                        </div>
                        <span>{{ t.generating_report if t else 'Generating report' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const fileInput = document.getElementById('fileInput');
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    const fileName = document.getElementById('fileName');
    const fileInputDisplay = document.getElementById('fileInputDisplay');
    const errorMessage = document.getElementById('errorMessage');
    const noFileText = '{{ t.no_file_chosen if t else "No file chosen" }}';

    // Click on custom button triggers file input
    chooseFileBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });

    // Also allow clicking anywhere on the display area
    fileInputDisplay.addEventListener('click', function(e) {
        if (e.target !== chooseFileBtn && !chooseFileBtn.contains(e.target)) {
            fileInput.click();
        }
    });

    // Update displayed filename when file is selected
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileName.textContent = this.files[0].name;
            fileName.classList.add('has-file');
            errorMessage.style.display = 'none';
        } else {
            fileName.textContent = noFileText;
            fileName.classList.remove('has-file');
        }
    });

    // Drag and drop support
    const uploadCard = document.querySelector('.upload-card');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadCard.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadCard.addEventListener(eventName, () => {
            uploadCard.classList.add('drag-over');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadCard.addEventListener(eventName, () => {
            uploadCard.classList.remove('drag-over');
        }, false);
    });

    uploadCard.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            fileInput.files = files;
            fileName.textContent = files[0].name;
            fileName.classList.add('has-file');
            errorMessage.style.display = 'none';
        }
    }, false);

    // Handle language switching - reload page with new language
    document.getElementById('languageSelect').addEventListener('change', function() {
        const newLang = this.value;
        const url = new URL(window.location.href);
        url.searchParams.set('lang', newLang);
        window.location.href = url.toString();
    });

    // Validation and loading animation on form submit
    const loadingOverlay = document.getElementById('loadingOverlay');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    document.getElementById('uploadForm').onsubmit = function(e) {
        if (fileInput.files.length === 0) {
            e.preventDefault();
            errorMessage.style.display = 'block';
            uploadCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }

        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Animate progress steps
        setTimeout(() => {
            step1.classList.remove('active');
            step1.classList.add('completed');
            step2.classList.add('active');
        }, 1500);

        setTimeout(() => {
            step2.classList.remove('active');
            step2.classList.add('completed');
            step3.classList.add('active');
        }, 3500);

        // Form will submit naturally and redirect to result page
        return true;
    };

    // Model type description update
    const modelSelect = document.getElementById('modelSelect');
    const modelDesc = document.getElementById('modelDesc');
    const modelDescriptions = {
        'mllm': '{{ t.model_desc_mllm if t else "Claude Vision AI for advanced image analysis" }}',
        'openai': '{{ t.model_desc_openai if t else "OpenAI GPT-4o Vision for advanced image analysis" }}',
        'openai_sam': '{{ t.model_desc_openai_sam if t else "OpenAI + SAM combined pipeline - Coming Soon" }}',
        'mock': '{{ t.model_desc_mock if t else "Mock data for UI testing without API calls" }}'
    };

    modelSelect.addEventListener('change', function() {
        modelDesc.textContent = modelDescriptions[this.value] || '';
    });
</script>
{% endblock %}
