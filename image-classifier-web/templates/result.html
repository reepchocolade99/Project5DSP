{% extends "layout.html" %}

{% block title %}{{ t.page_title }}{% endblock %}

{% block content %}
<main class="result-page">
    <!-- Tab Navigation -->
    <div class="tab-container">
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="report">{{ t.tab_report }}</button>
            <button class="tab-btn" data-tab="summary">{{ t.tab_summary }}</button>
        </nav>
        <div class="tab-actions">
            <span class="generated-time">{{ t.generated }}: {{ generated_at }}</span>
        </div>
    </div>

    <!-- ==================== REPORT TAB ==================== -->
    <div class="tab-content active" id="tab-report">
        <div class="report-layout">
            <!-- Left Column: Narrative Sections -->
            <div class="report-main">
                <div class="report-header-card">
                    <div class="case-badge">
                        <span class="badge-label">{{ t.case }}</span>
                        <span class="badge-value">{{ doc_summary.case.volgnummer or t.not_available }}</span>
                    </div>
                    <div class="violation-badge {% if doc_summary.violation.code and doc_summary.violation.code != t.not_specified %}has-code{% endif %}">
                        <span class="violation-code">{{ doc_summary.violation.code or '?' }}</span>
                        <span class="violation-desc">{{ doc_summary.violation.description or t.parking_violation }}</span>
                    </div>
                    {% if sam3_results and sam3_results.recommendation_ui %}
                    <!-- Legal v2: Recommendation Badge - Improved with AlertTriangle for manual review -->
                    <div class="recommendation-badge {{ sam3_results.recommendation_ui.color }}">
                        <span class="rec-icon">
                            {% if sam3_results.recommendation_ui.action == 'approve' %}
                            <!-- CheckCircle icon -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            {% elif sam3_results.recommendation_ui.action == 'reject' %}
                            <!-- XCircle icon -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            {% else %}
                            <!-- AlertTriangle icon for manual review -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            {% endif %}
                        </span>
                        <span class="rec-label">{{ sam3_results.recommendation_ui.label }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if sam3_results and (sam3_results.pipeline_version == '2.0' or sam3_results.pipeline_version == '2.0-parallel') and sam3_results.legal_assessment %}
                <!-- ==================== LEGAL DECISION AREA (Moved to Main Content) ==================== -->

                <!-- Legal Basis Card - Prominent Position -->
                <div class="legal-basis-main-card">
                    <div class="legal-basis-header">
                        <span class="legal-basis-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1v6M12 17v6M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M1 12h6M17 12h6M4.93 19.07l4.24-4.24M14.83 9.17l4.24-4.24"/>
                            </svg>
                        </span>
                        <h3>{{ t.legal_basis if t.legal_basis else 'Legal Basis' }}</h3>
                    </div>
                    <div class="legal-basis-content">
                        {% if sam3_results.legal_assessment.legal_references %}
                        <div class="legal-basis-grid">
                            <div class="legal-basis-item">
                                <span class="legal-basis-label">{{ t.primary if t.primary else 'Primary Article' }}</span>
                                <a href="{{ sam3_results.legal_assessment.legal_references.violation_article_url or '#' }}"
                                   target="_blank" rel="noopener" class="legal-basis-link">
                                    {{ sam3_results.legal_assessment.legal_references.violation_article }}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                            <div class="legal-basis-item">
                                <span class="legal-basis-label">{{ t.towing if t.towing else 'Towing Basis' }}</span>
                                <a href="{{ sam3_results.legal_assessment.legal_references.wegslepen_url or '#' }}"
                                   target="_blank" rel="noopener" class="legal-basis-link">
                                    {{ sam3_results.legal_assessment.legal_references.wegslepen_basis }}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                            <div class="legal-basis-item">
                                <span class="legal-basis-label">{{ t.feit_code if t.feit_code else 'Feit Code' }}</span>
                                <span class="feit-code-display">{{ sam3_results.legal_assessment.feit_code }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Evidence Checklist - With Legend -->
                {% if sam3_results.evidence_checklist %}
                <div class="evidence-checklist-main-card">
                    <div class="checklist-header">
                        <div class="checklist-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            <h3>{{ t.evidence_checklist if t.evidence_checklist else 'Evidence Checklist' }}</h3>
                        </div>
                        {% if sam3_results.legal_assessment.verification_score is defined %}
                        <span class="checklist-badge {% if sam3_results.legal_assessment.verification_score >= 0.8 %}success{% elif sam3_results.legal_assessment.verification_score >= 0.5 %}warning{% else %}danger{% endif %}">
                            {{ (sam3_results.legal_assessment.verification_score * 100)|int }}% Verified
                        </span>
                        {% endif %}
                    </div>

                    <!-- Legend -->
                    <div class="checklist-legend">
                        <span class="legend-item confirmed">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Confirmed
                        </span>
                        <span class="legend-item unverifiable">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Unverifiable
                        </span>
                        <span class="legend-item failed">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Failed
                        </span>
                    </div>

                    <!-- Checklist Items -->
                    <div class="checklist-items-main">
                        {% for item in sam3_results.evidence_checklist %}
                        <div class="checklist-item-main {{ item.status }}">
                            <span class="check-status-icon">
                                {% if item.status == 'passed' %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                {% elif item.status == 'failed' %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                {% else %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                {% endif %}
                            </span>
                            <div class="check-item-content">
                                <span class="check-item-title">{{ item.description }}</span>
                                {% if item.legal_reference %}
                                <span class="check-item-ref">{{ item.legal_reference }}</span>
                                {% endif %}
                            </div>
                            {% if item.confidence %}
                            <span class="check-item-conf">{{ (item.confidence * 100)|int }}%</span>
                            {% endif %}
                            {% if item.source == 'officer' %}
                            <span class="check-item-source">from officer</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    {% if sam3_results.legal_assessment.unverifiable_checks %}
                    <div class="unverifiable-note">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span>{{ sam3_results.legal_assessment.unverifiable_checks|length }} item(s) could not be verified from image evidence</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Legal Statement - Enhanced and Prominent -->
                {% if sam3_results.legal_statement %}
                <div class="legal-statement-main-card">
                    <div class="statement-header">
                        <div class="statement-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <h3>{{ t.legal_statement if t.legal_statement else 'Legal Statement' }}</h3>
                        </div>
                        <div class="statement-controls">
                            <div class="lang-tabs">
                                <button class="lang-tab {% if lang == 'nl' %}active{% endif %}" data-lang="nl">Nederlands</button>
                                <button class="lang-tab {% if lang == 'en' %}active{% endif %}" data-lang="en">English</button>
                            </div>
                            <button class="copy-statement-main-btn" title="{{ t.copy_to_clipboard }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span>{{ t.copy_btn if t.copy_btn else 'Copy' }}</span>
                            </button>
                        </div>
                    </div>
                    <div class="statement-body">
                        <div class="statement-text-main {% if lang == 'nl' %}active{% endif %}" id="mainLegalStatementNL">
                            <p>{{ sam3_results.legal_statement.nl }}</p>
                        </div>
                        <div class="statement-text-main {% if lang == 'en' %}active{% endif %}" id="mainLegalStatementEN">
                            <p>{{ sam3_results.legal_statement.en }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Additional Details Header -->
                <div class="additional-details-header">
                    <h4>{{ t.additional_details if t.additional_details else 'Additional Details' }}</h4>
                </div>
                {% endif %}

                <!-- Report Sections (AI-generated content) -->
                <div class="sections-container {% if sam3_results and (sam3_results.pipeline_version == '2.0' or sam3_results.pipeline_version == '2.0-parallel') %}collapsible-sections{% endif %}">
                    {% for section in report_sections %}
                    {% if section.source != 'document' %}
                    <div class="report-section" data-section-id="{{ section.id }}">
                        <div class="section-header">
                            <h3>{{ section.title }}</h3>
                            <div class="section-badges">
                                {% if section.source == 'document' %}
                                <span class="source-badge document">{{ t.from_document }}</span>
                                {% elif section.source == 'model' %}
                                <span class="source-badge model">{{ t.ai_generated }}</span>
                                {% elif section.source == 'template' %}
                                <span class="source-badge template">{{ t.legal_template }}</span>
                                {% elif section.source == 'missing' %}
                                <span class="source-badge missing">{{ t.missing_data }}</span>
                                {% else %}
                                <span class="source-badge system">{{ t.system }}</span>
                                {% endif %}

                                {% if section.editable %}
                                <button class="btn-icon copy-btn" title="{{ t.copy_to_clipboard }}" data-content="{{ section.content }}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="section-content">
                            {% if section.editable %}
                            <div class="editable-content" contenteditable="true">{{ section.content }}</div>
                            {% else %}
                            <p>{{ section.content }}</p>
                            {% endif %}

                            {% if section.confidence %}
                            <div class="inline-confidence">
                                <span>{{ t.confidence }}:</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width: {{ (section.confidence * 100)|int }}%"></div>
                                </div>
                                <span>{{ (section.confidence * 100)|int }}%</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Right Column: Image Inspector + Confidence -->
            <div class="report-sidebar">
                <!-- Image Inspector -->
                <div class="inspector-card">
                    <h4>{{ t.evidence_inspector }}</h4>

                    {% if extracted_images %}
                    <div class="inspector-main-image">
                        <img id="inspectorImage" src="{{ url_for('data_file', filename=extracted_images[0]) }}" alt="Selected evidence">
                    </div>

                    <div class="inspector-details">
                        <div class="detail-row">
                            <span class="detail-label">{{ t.filename }}:</span>
                            <span class="detail-value" id="inspectorFilename">{{ extracted_images[0] }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">{{ t.page }}:</span>
                            <span class="detail-value" id="inspectorPage">{{ images_metadata[0].page if images_metadata else '-' }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">{{ t.method }}:</span>
                            <span class="detail-value" id="inspectorMethod">{{ images_metadata[0].method if images_metadata else '-' }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">{{ t.size }}:</span>
                            <span class="detail-value" id="inspectorSize">{{ images_metadata[0].width if images_metadata else '-' }} x {{ images_metadata[0].height if images_metadata else '-' }}</span>
                        </div>
                    </div>

                    <!-- Image Thumbnails - Moved here for better layout -->
                    <div class="thumbnail-strip">
                        {% for img in extracted_images %}
                        <div class="thumb {% if loop.first %}selected{% endif %}"
                             data-index="{{ loop.index0 }}"
                             data-filename="{{ img }}"
                             data-page="{{ images_metadata[loop.index0].page if images_metadata else '-' }}"
                             data-method="{{ images_metadata[loop.index0].method if images_metadata else '-' }}"
                             data-width="{{ images_metadata[loop.index0].width if images_metadata else '-' }}"
                             data-height="{{ images_metadata[loop.index0].height if images_metadata else '-' }}"
                             {% if sam3_results and sam3_results.per_image %}
                             data-sam3-id="{{ sam3_results.per_image.keys()|list|first if loop.first else '' }}"
                             {% endif %}>
                            <img src="{{ url_for('data_file', filename=img) }}" alt="Evidence {{ loop.index }}">
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Extracted Text - License Plate -->
                    {% if doc_summary.vehicle.kenteken and doc_summary.vehicle.kenteken != t.not_available %}
                    <div class="extracted-text-box">
                        <h5>{{ t.extracted_text }}</h5>
                        <div class="plate-display">{{ doc_summary.vehicle.kenteken }}</div>
                    </div>
                    {% endif %}

                    <!-- ═══════════════════════════════════════════════════════════════════ -->
                    <!-- UNIFIED OBJECT DETECTION ANALYSIS SECTION -->
                    <!-- ═══════════════════════════════════════════════════════════════════ -->

                    <!-- Object Detection Analysis Card - Unified for all model types -->
                    <div class="object-detection-card">
                        <div class="detection-card-header">
                            <div class="detection-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <h5>{{ t.detected_items }}</h5>
                            </div>
                            {% if detected_items_ui and detected_items_ui.get('parallel_mode') %}
                            <span class="analysis-mode-badge parallel">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5"></path>
                                </svg>
                                Cross-Validated
                            </span>
                            {% elif model_type == 'openai_sam' %}
                            <span class="analysis-mode-badge parallel">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5"></path>
                                </svg>
                                OpenAI + SAM3
                            </span>
                            {% elif model_type == 'openai' %}
                            <span class="analysis-mode-badge openai">OpenAI</span>
                            {% elif model_type == 'mllm' %}
                            <span class="analysis-mode-badge claude">Claude</span>
                            {% elif model_type == 'mock' %}
                            <span class="analysis-mode-badge mock">Mock</span>
                            {% endif %}
                        </div>

                        {% if detected_items_ui and detected_items_ui.get('parallel_mode') %}
                        <!-- ══════ CROSS-VALIDATION MODE (OpenAI + SAM3) ══════ -->

                        {% if detected_items_ui['items'] %}
                        {#
                        NEW PARKING VIOLATION LOGIC:
                        - is_absence_based: True for items where NOT finding = GOOD (driver, permit)
                        - detected: True when check PASSES (presence found OR absence confirmed)
                        - Confidence values are already INVERTED for absence-based items
                        #}

                        {# Categorize items by type #}
                        {% set hallucination_items = [] %}
                        {% set absence_detected_items = [] %}
                        {% set presence_detected_items = [] %}
                        {% set unverified_items = [] %}

                        {% for item in detected_items_ui['items'] %}
                            {% if item.is_hallucination_risk %}
                                {% set _ = hallucination_items.append(item) %}
                            {% elif item.detected and item.get('is_absence_based', false) %}
                                {# Absence confirmed (no driver, no permit) - GREEN #}
                                {% set _ = absence_detected_items.append(item) %}
                            {% elif item.detected %}
                                {# Presence confirmed (vehicle, sign) - GREEN #}
                                {% set _ = presence_detected_items.append(item) %}
                            {% else %}
                                {# Unverified - needs manual check #}
                                {% set _ = unverified_items.append(item) %}
                            {% endif %}
                        {% endfor %}

                        {# Scrollable container for detection cards #}
                        <div class="detection-items-scroll-container">
                            <div class="detection-items-grid" id="detectionList">

                                {# === HALLUCINATION RISK ITEMS (presence-based only) === #}
                                {% for item in hallucination_items %}
                                <div class="detection-item-card hallucination-risk">
                                    <div class="item-header">
                                        <span class="item-label">
                                            <svg class="warning-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                            </svg>
                                            {{ item.label }}
                                        </span>
                                        <span class="item-status hallucination">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="confidence-bars">
                                        <div class="confidence-row">
                                            <span class="source-name sam3">SAM3</span>
                                            <div class="bar-container">
                                                <div class="bar-fill sam3" style="width: {{ item.sam3_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.sam3_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row">
                                            <span class="source-name openai">OpenAI</span>
                                            <div class="bar-container">
                                                <div class="bar-fill openai" style="width: {{ item.openai_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.openai_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row final">
                                            <span class="source-name final">Final</span>
                                            <div class="bar-container">
                                                <div class="bar-fill final warning" style="width: {{ item.confidence }}%"></div>
                                            </div>
                                            <span class="conf-value warning">{{ item.confidence }}%</span>
                                        </div>
                                    </div>
                                    <div class="risk-note">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                            <line x1="12" y1="9" x2="12" y2="13"></line>
                                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                        </svg>
                                        {{ item.reasoning }}
                                    </div>
                                </div>
                                {% endfor %}

                                {# === ABSENCE CONFIRMED ITEMS (no driver, no permit) - GREEN === #}
                                {% for item in absence_detected_items %}
                                <div class="detection-item-card absence-confirmed">
                                    <div class="item-header">
                                        <span class="item-label">
                                            <svg class="absence-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                            </svg>
                                            {{ item.label }}
                                        </span>
                                        <span class="item-status detected">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="confidence-bars">
                                        <div class="confidence-row">
                                            <span class="source-name sam3">SAM3</span>
                                            <div class="bar-container">
                                                <div class="bar-fill sam3" style="width: {{ item.sam3_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.sam3_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row">
                                            <span class="source-name openai">OpenAI</span>
                                            <div class="bar-container">
                                                <div class="bar-fill openai" style="width: {{ item.openai_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.openai_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row final">
                                            <span class="source-name final">Result</span>
                                            <div class="bar-container">
                                                <div class="bar-fill final success" style="width: {{ item.confidence }}%"></div>
                                            </div>
                                            <span class="conf-value success">{{ item.confidence }}%</span>
                                        </div>
                                    </div>
                                    <div class="absence-note">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        {{ item.reasoning }}
                                    </div>
                                </div>
                                {% endfor %}

                                {# === PRESENCE DETECTED ITEMS (vehicle, sign, plate) - GREEN === #}
                                {% for item in presence_detected_items %}
                                <div class="detection-item-card detected">
                                    <div class="item-header">
                                        <span class="item-label">{{ item.label }}</span>
                                        <span class="item-status detected">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="confidence-bars">
                                        <div class="confidence-row">
                                            <span class="source-name sam3">SAM3</span>
                                            <div class="bar-container">
                                                <div class="bar-fill sam3" style="width: {{ item.sam3_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.sam3_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row">
                                            <span class="source-name openai">OpenAI</span>
                                            <div class="bar-container">
                                                <div class="bar-fill openai" style="width: {{ item.openai_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.openai_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row final">
                                            <span class="source-name final">Final</span>
                                            <div class="bar-container">
                                                <div class="bar-fill final" style="width: {{ item.confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.confidence }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                {# === UNVERIFIED ITEMS (low confidence) - YELLOW === #}
                                {% for item in unverified_items %}
                                <div class="detection-item-card unverified">
                                    <div class="item-header">
                                        <span class="item-label">{{ item.label }}</span>
                                        <span class="item-status unverified">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="confidence-bars">
                                        <div class="confidence-row">
                                            <span class="source-name sam3">SAM3</span>
                                            <div class="bar-container">
                                                <div class="bar-fill sam3" style="width: {{ item.sam3_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.sam3_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row">
                                            <span class="source-name openai">OpenAI</span>
                                            <div class="bar-container">
                                                <div class="bar-fill openai" style="width: {{ item.openai_confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.openai_confidence }}%</span>
                                        </div>
                                        <div class="confidence-row final">
                                            <span class="source-name final">Final</span>
                                            <div class="bar-container">
                                                <div class="bar-fill final unverified" style="width: {{ item.confidence }}%"></div>
                                            </div>
                                            <span class="conf-value">{{ item.confidence }}%</span>
                                        </div>
                                    </div>
                                    {% if item.reasoning %}
                                    <div class="unverified-note">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        {{ item.reasoning }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        {# Summary of not detected items from server-side filtering #}
                        {% if detected_items_ui.get('not_detected_labels') and detected_items_ui['not_detected_labels']|length > 0 %}
                        <div class="not-detected-summary">
                            <span class="summary-label">{{ t.not_detected_label if t.not_detected_label else 'Not scanned' }}:</span>
                            <span class="summary-items">
                                {% for label in detected_items_ui['not_detected_labels'] %}{{ label }}{% if not loop.last %}, {% endif %}{% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% else %}
                        <!-- ══════ STANDARD MODE (Claude/OpenAI/Mock) ══════ -->

                        {% if detected_items_ui and detected_items_ui['items'] %}
                        <div class="detection-items-list" id="detectionList">
                            {% for item in detected_items_ui['items'] %}
                            {# Determine card type based on detection status #}
                            {% set card_class = 'absence_confirmed' if item.detected and item.get('is_absence_based', false) else ('presence_detected' if item.detected else 'not_detected') %}

                            <div class="detection-card {{ card_class }}">
                                <div class="card-indicator"></div>
                                <div class="card-content">
                                    <div class="card-header">
                                        <span class="card-icon">
                                            {% if item.detected %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                            </svg>
                                            {% else %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                            </svg>
                                            {% endif %}
                                        </span>
                                        <span class="card-label">{{ item.label }}</span>
                                        <span class="card-badge">
                                            {% if item.detected %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                            {% else %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                            {% endif %}
                                        </span>
                                    </div>

                                    {% if item.extracted_text or item.sign_code %}
                                    <div class="card-details">
                                        {% if item.extracted_text %}<span class="detail-text">{{ item.extracted_text }}</span>{% endif %}
                                        {% if item.sign_code %}<span class="detail-text">{{ item.sign_code }}</span>{% endif %}
                                    </div>
                                    {% endif %}

                                    <div class="confidence-section">
                                        <div class="confidence-row">
                                            <span class="source-label">RESULT</span>
                                            <div class="bar-wrapper">
                                                <div class="bar-track">
                                                    <div class="bar-fill final {% if item.detected %}success{% else %}warning{% endif %}" style="width: {{ item.confidence }}%"></div>
                                                </div>
                                            </div>
                                            <span class="conf-value {% if item.detected %}success{% else %}warning{% endif %}">{{ item.confidence }}%</span>
                                        </div>
                                    </div>

                                    {% if item.reasoning %}
                                    <div class="card-reasoning">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        <span>{{ item.reasoning }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="detection-empty">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <p>{{ t.mllm_coming_soon }}</p>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <!-- Verification Summary (for all MLLM modes) -->
                    {% if sam3_results and sam3_results.mllm_mode and sam3_results.verification %}
                    <div class="verification-summary-card">
                        <div class="verification-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            <span>{{ t.verification_status if t.verification_status else 'Verification' }}</span>
                        </div>
                        <div class="verification-content {{ 'verified' if sam3_results.verification.observation_supported else 'warning' }}">
                            <div class="verification-status">
                                {% if sam3_results.verification.observation_supported %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                <span>{{ t.observation_supported if t.observation_supported else 'Evidence supports observation' }}</span>
                                {% else %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                <span>{{ t.discrepancies_found if t.discrepancies_found else 'Discrepancies found' }}</span>
                                {% endif %}
                            </div>
                            <div class="verification-score">
                                <span class="score-label">{{ t.confidence }}:</span>
                                <span class="score-value">{{ (sam3_results.verification.overall_confidence * 100)|int }}%</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="no-images-placeholder">
                        <p>{{ t.no_images_available }}</p>
                    </div>
                    {% endif %}
                </div>

                {# Hide Confidence Summary for parallel mode - redundant info shown in detection cards #}
                {% if not (detected_items_ui and detected_items_ui.get('parallel_mode')) %}
                <!-- Confidence Summary -->
                <div class="confidence-card">
                    <h4>{{ t.confidence_scores }}</h4>
                    <div class="confidence-list">
                        <div class="confidence-item">
                            <div class="conf-header">
                                <span>{{ t.object_detection }}</span>
                                <strong>{{ (confidence_scores.object_detection * 100)|int }}%</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (confidence_scores.object_detection * 100)|int }}%"></div>
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="conf-header">
                                <span>{{ t.text_recognition }}</span>
                                <strong>{{ (confidence_scores.text_recognition * 100)|int }}%</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (confidence_scores.text_recognition * 100)|int }}%"></div>
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="conf-header">
                                <span>{{ t.legal_reasoning }}</span>
                                <strong>{{ (confidence_scores.legal_reasoning * 100)|int }}%</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ (confidence_scores.legal_reasoning * 100)|int }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Legal v2 components moved to main content area -->
            </div>
        </div>
    </div>

    <!-- ==================== DOCUMENT SUMMARY TAB ==================== -->
    <div class="tab-content" id="tab-summary">
        <div class="summary-layout">
            <!-- Left Column: Structured Fields -->
            <div class="summary-main">
                <!-- Case Identifiers -->
                <div class="summary-card">
                    <h4>{{ t.case_identifiers }}</h4>
                    <div class="field-grid">
                        <div class="field-item">
                            <span class="field-label">{{ t.sequence_number }}</span>
                            <span class="field-value">{{ doc_summary.case.volgnummer or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.ticket_number }}</span>
                            <span class="field-value">{{ doc_summary.case.bonnummer or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.status }}</span>
                            <span class="field-value status-badge">{{ doc_summary.case.status or t.unknown }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.date_time }}</span>
                            <span class="field-value">{{ doc_summary.case.datum_tijd or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.employee }}</span>
                            <span class="field-value">{{ doc_summary.case.medewerker or t.not_available }}</span>
                        </div>
                    </div>
                </div>

                <!-- Location -->
                <div class="summary-card">
                    <h4>{{ t.location }}</h4>
                    <div class="field-grid">
                        <div class="field-item">
                            <span class="field-label">{{ t.city }}</span>
                            <span class="field-value">{{ doc_summary.location.plaats or 'Amsterdam' }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.district }}</span>
                            <span class="field-value">{{ doc_summary.location.stadsdeel or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.neighborhood }}</span>
                            <span class="field-value">{{ doc_summary.location.buurt or t.not_available }}</span>
                        </div>
                        <div class="field-item full-width">
                            <span class="field-label">{{ t.street }}</span>
                            <span class="field-value">{{ doc_summary.location.straat or t.not_available }} {{ doc_summary.location.locatie_nr or '' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Violation -->
                <div class="summary-card violation-card">
                    <h4>{{ t.violation }}</h4>
                    <div class="violation-display">
                        <div class="violation-sign">
                            <span class="sign-code">{{ doc_summary.violation.code or '?' }}</span>
                        </div>
                        <div class="violation-info">
                            <div class="field-item">
                                <span class="field-label">{{ t.description }}</span>
                                <span class="field-value">{{ doc_summary.violation.description or t.not_available }}</span>
                            </div>
                            <div class="field-item">
                                <span class="field-label">{{ t.clarification }}</span>
                                <span class="field-value">{{ doc_summary.violation.toelichting or t.none }}</span>
                            </div>
                            {% if doc_summary.violation.reden_verwijdering and doc_summary.violation.reden_verwijdering != t.not_available %}
                            <div class="field-item">
                                <span class="field-label">{{ t.removal_reason }}</span>
                                <span class="field-value">{{ doc_summary.violation.reden_verwijdering }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Vehicle -->
                <div class="summary-card">
                    <h4>{{ t.vehicle_info }}</h4>
                    <div class="field-grid">
                        <div class="field-item">
                            <span class="field-label">{{ t.license_plate_label }}</span>
                            <span class="field-value plate-value">{{ doc_summary.vehicle.kenteken or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.brand }}</span>
                            <span class="field-value">{{ doc_summary.vehicle.merk or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.model }}</span>
                            <span class="field-value">{{ doc_summary.vehicle.model or t.not_available }}</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">{{ t.color }}</span>
                            <span class="field-value">{{ doc_summary.vehicle.kleur or t.not_available }}</span>
                        </div>
                    </div>
                </div>

                <!-- Officer Observation -->
                <div class="summary-card">
                    <h4>{{ t.officer_observation }}</h4>
                    <div class="observation-box">
                        {% if doc_summary.officer_observation %}
                        <p>{{ doc_summary.officer_observation }}</p>
                        <span class="source-badge document">{{ t.from_document }}</span>
                        {% else %}
                        <p class="no-data">{{ t.no_observation }}</p>
                        <span class="source-badge missing">{{ t.missing_data }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Related Registrations -->
                {% if doc_summary.related_registrations %}
                <div class="summary-card">
                    <h4>{{ t.related_registrations }}</h4>
                    <table class="registrations-table">
                        <thead>
                            <tr>
                                <th>{{ t.type }}</th>
                                <th>{{ t.reference }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reg in doc_summary.related_registrations %}
                            <tr>
                                <td>{{ reg.type }}</td>
                                <td>{{ reg.reference }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>

            <!-- Right Column: Evidence Images + Export -->
            <div class="summary-sidebar">
                <!-- Evidence Images -->
                <div class="evidence-card">
                    <h4>{{ t.evidence_images }} ({{ extracted_images|length }})</h4>
                    {% if extracted_images %}
                    <div class="evidence-grid">
                        {% for img in extracted_images %}
                        <div class="evidence-item">
                            <img src="{{ url_for('data_file', filename=img) }}" alt="Evidence {{ loop.index }}">
                            <div class="evidence-meta">
                                <span class="evidence-name">{{ img|truncate(25) }}</span>
                                <span class="evidence-info">{{ t.page }} {{ images_metadata[loop.index0].page if images_metadata else '-' }} | {{ images_metadata[loop.index0].method if images_metadata else '-' }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-evidence">
                        <p>{{ t.no_images_extracted }}</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Export Actions -->
                <div class="export-card">
                    <h4>{{ t.export_options }}</h4>
                    <div class="export-buttons">
                        <button class="btn btn-primary" id="downloadPdfBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            {{ t.download_pdf_report }}
                        </button>
                        <button class="btn btn-outline" id="exportJsonBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            {{ t.export_json }}
                        </button>
                        <button class="btn btn-outline" id="downloadImagesBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            {{ t.download_images }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar (Fixed Bottom) -->
    <div class="quick-actions-bar">
        <div class="quick-actions-content">
            <!-- Left: Back to New Analysis -->
            <a href="/" class="action-btn action-btn-outline">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                {{ t.new_analysis }}
            </a>

            <!-- Right: Action Buttons -->
            <div class="quick-actions-right">
                <button class="action-btn action-btn-outline" id="quickDownloadPdfBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    {{ t.download_pdf if t.download_pdf else 'Download PDF' }}
                </button>

                <button class="action-btn action-btn-outline" id="quickExportJsonBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    {{ t.export_json }}
                </button>

                {% if sam3_results and (sam3_results.pipeline_version == '2.0' or sam3_results.pipeline_version == '2.0-parallel') and sam3_results.recommendation %}
                {% if sam3_results.recommendation.action == 'approve' %}
                <button class="action-btn action-btn-primary" id="quickApproveBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    {{ t.approve if t.approve else 'Approve Case' }}
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</main>

<!-- Hidden data for JS -->
<script id="docSummaryData" type="application/json">
{{ doc_summary | tojson | safe }}
</script>
<script id="reportSectionsData" type="application/json">
{{ report_sections | tojson | safe }}
</script>
<script id="confidenceData" type="application/json">
{{ confidence_scores | tojson | safe }}
</script>
{% if sam3_results %}
<script id="sam3Data" type="application/json">
{{ sam3_results | tojson | safe }}
</script>
{% endif %}
{% if detected_items_ui %}
<script id="detectedItemsData" type="application/json">
{{ detected_items_ui | tojson | safe }}
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get SAM3 data if available
    const sam3DataEl = document.getElementById('sam3Data');
    const sam3Data = sam3DataEl ? JSON.parse(sam3DataEl.textContent) : null;

    // Translation strings (passed from server)
    const translations = {
        showOverlay: '{{ t.show_overlay }}',
        hideOverlay: '{{ t.hide_overlay }}',
        detected: '{{ t.detected }}',
        notDetected: '{{ t.not_detected }}'
    };

    // Track current state
    let currentImageFilename = '{{ extracted_images[0] if extracted_images else "" }}';
    let showingOverlay = false;

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;

            // Update buttons
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === 'tab-' + targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });

    // Image thumbnail selection with SAM3 integration
    const thumbs = document.querySelectorAll('.thumb');
    const inspectorImage = document.getElementById('inspectorImage');
    const inspectorFilename = document.getElementById('inspectorFilename');
    const inspectorPage = document.getElementById('inspectorPage');
    const inspectorMethod = document.getElementById('inspectorMethod');
    const inspectorSize = document.getElementById('inspectorSize');

    thumbs.forEach(thumb => {
        thumb.addEventListener('click', () => {
            // Update selection
            thumbs.forEach(t => t.classList.remove('selected'));
            thumb.classList.add('selected');

            // Update inspector
            const filename = thumb.dataset.filename;
            currentImageFilename = filename;

            // Reset overlay state
            showingOverlay = false;
            const overlayBtn = document.getElementById('toggleOverlay');
            if (overlayBtn) {
                overlayBtn.dataset.showing = 'false';
                document.getElementById('overlayBtnText').textContent = translations.showOverlay;
            }

            inspectorImage.src = '/data/' + filename;
            inspectorFilename.textContent = filename;
            inspectorPage.textContent = thumb.dataset.page;
            inspectorMethod.textContent = thumb.dataset.method;
            inspectorSize.textContent = thumb.dataset.width + ' x ' + thumb.dataset.height;
        });
    });

    // SAM3 Overlay Toggle
    const toggleOverlayBtn = document.getElementById('toggleOverlay');
    if (toggleOverlayBtn && sam3Data) {
        toggleOverlayBtn.addEventListener('click', () => {
            showingOverlay = !showingOverlay;
            toggleOverlayBtn.dataset.showing = showingOverlay ? 'true' : 'false';
            document.getElementById('overlayBtnText').textContent =
                showingOverlay ? translations.hideOverlay : translations.showOverlay;

            if (showingOverlay) {
                // Find overlay URL for current image
                const perImage = sam3Data.per_image || {};
                for (const [imageId, result] of Object.entries(perImage)) {
                    if (result.filename === currentImageFilename && result.overlay_url) {
                        inspectorImage.src = result.overlay_url;
                        break;
                    }
                }
            } else {
                // Show original image
                inspectorImage.src = '/data/' + currentImageFilename;
            }
        });
    }

    // View crop links
    document.querySelectorAll('.view-crop-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const cropType = link.dataset.crop;

            if (sam3Data && sam3Data.per_image) {
                for (const [imageId, result] of Object.entries(sam3Data.per_image)) {
                    if (result.filename === currentImageFilename) {
                        const rois = result.derived_rois || {};
                        const cropUrl = rois[cropType + '_crop_url'];
                        if (cropUrl) {
                            // Open crop in new window/modal
                            window.open(cropUrl, '_blank', 'width=400,height=300');
                        }
                        break;
                    }
                }
            }
        });
    });

    // Copy to clipboard
    const copyBtns = document.querySelectorAll('.copy-btn');
    copyBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const section = btn.closest('.report-section');
            const content = section.querySelector('.editable-content, p').textContent;
            navigator.clipboard.writeText(content).then(() => {
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 2000);
            });
        });
    });

    // Export JSON
    document.getElementById('exportJsonBtn')?.addEventListener('click', () => {
        const docSummary = JSON.parse(document.getElementById('docSummaryData').textContent);
        const reportSections = JSON.parse(document.getElementById('reportSectionsData').textContent);
        const confidence = JSON.parse(document.getElementById('confidenceData').textContent);

        const exportData = {
            document_summary: docSummary,
            report_sections: reportSections,
            confidence_scores: confidence,
            exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'parking-case-export.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    // Editable content auto-save indicator
    const editables = document.querySelectorAll('.editable-content');
    editables.forEach(el => {
        el.addEventListener('input', () => {
            el.classList.add('modified');
        });
    });

    // Legal Statement Language Tabs (v2)
    const statementTabBtns = document.querySelectorAll('.statement-tab-btn');
    const statementTexts = document.querySelectorAll('.statement-text');

    statementTabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetLang = btn.dataset.lang;

            // Update tab buttons
            statementTabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update content
            statementTexts.forEach(text => {
                text.classList.remove('active');
                if (text.id === 'legalStatement' + targetLang.toUpperCase()) {
                    text.classList.add('active');
                }
            });
        });
    });

    // Copy Legal Statement (v2) - Sidebar version
    const copyStatementBtn = document.querySelector('.copy-statement-btn');
    if (copyStatementBtn) {
        copyStatementBtn.addEventListener('click', () => {
            // Get the active statement text
            const activeStatement = document.querySelector('.statement-text.active p');
            if (activeStatement) {
                navigator.clipboard.writeText(activeStatement.textContent).then(() => {
                    copyStatementBtn.classList.add('copied');
                    const originalText = copyStatementBtn.innerHTML;
                    copyStatementBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> {{ t.copied if t.copied else "Copied!" }}';
                    setTimeout(() => {
                        copyStatementBtn.classList.remove('copied');
                        copyStatementBtn.innerHTML = originalText;
                    }, 2000);
                });
            }
        });
    }

    // ==================== NEW MAIN CONTENT COMPONENT HANDLERS ====================

    // Main Legal Statement Language Tabs
    const mainLangTabs = document.querySelectorAll('.lang-tab');
    const mainStatementTexts = document.querySelectorAll('.statement-text-main');

    mainLangTabs.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetLang = btn.dataset.lang;

            // Update tab buttons
            mainLangTabs.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update content
            mainStatementTexts.forEach(text => {
                text.classList.remove('active');
                if (text.id === 'mainLegalStatement' + targetLang.toUpperCase()) {
                    text.classList.add('active');
                }
            });
        });
    });

    // Main Legal Statement Copy Button
    const copyMainStatementBtn = document.querySelector('.copy-statement-main-btn');
    if (copyMainStatementBtn) {
        copyMainStatementBtn.addEventListener('click', () => {
            const activeStatement = document.querySelector('.statement-text-main.active p');
            if (activeStatement) {
                navigator.clipboard.writeText(activeStatement.textContent).then(() => {
                    copyMainStatementBtn.classList.add('copied');
                    const originalHTML = copyMainStatementBtn.innerHTML;
                    copyMainStatementBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>{{ t.copied if t.copied else "Copied!" }}</span>';
                    setTimeout(() => {
                        copyMainStatementBtn.classList.remove('copied');
                        copyMainStatementBtn.innerHTML = originalHTML;
                    }, 2000);
                });
            }
        });
    }

    // Collapsible AI Sections (for v2 pipeline)
    const collapsibleSections = document.querySelector('.collapsible-sections');
    if (collapsibleSections) {
        const sections = collapsibleSections.querySelectorAll('.report-section');
        sections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header) {
                // Start collapsed by default
                section.classList.add('collapsed');

                header.addEventListener('click', (e) => {
                    // Don't collapse if clicking on copy button
                    if (e.target.closest('.copy-btn')) return;
                    section.classList.toggle('collapsed');
                });
            }
        });
    }

    // ==================== QUICK ACTIONS BAR HANDLERS ====================

    // Quick Download PDF Button
    document.getElementById('quickDownloadPdfBtn')?.addEventListener('click', () => {
        // Trigger print dialog for PDF
        window.print();
    });

    // Quick Export JSON Button
    document.getElementById('quickExportJsonBtn')?.addEventListener('click', () => {
        const docSummary = JSON.parse(document.getElementById('docSummaryData').textContent);
        const reportSections = JSON.parse(document.getElementById('reportSectionsData').textContent);
        const confidence = JSON.parse(document.getElementById('confidenceData').textContent);
        const sam3DataEl = document.getElementById('sam3Data');
        const sam3Export = sam3DataEl ? JSON.parse(sam3DataEl.textContent) : null;

        const exportData = {
            document_summary: docSummary,
            report_sections: reportSections,
            confidence_scores: confidence,
            sam3_analysis: sam3Export,
            exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'parking-case-export.json';
        a.click();
        URL.revokeObjectURL(url);
    });

    // Quick Approve Button (if present)
    document.getElementById('quickApproveBtn')?.addEventListener('click', () => {
        // Show confirmation and mark as approved
        if (confirm('{{ t.confirm_approve if t.confirm_approve else "Are you sure you want to approve this case?" }}')) {
            const btn = document.getElementById('quickApproveBtn');
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> {{ t.approved if t.approved else "Approved" }}';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.cursor = 'default';
        }
    });
});
</script>
{% endblock %}
